<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root { --bg:#0b0b0c; --panel:#0b0b0c; --bd:#1f1f20; --txt:#eaeaea; --muted:#a0a0a0; --gold:#eab308; --green:#22c55e; --red:#ef4444; }
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:Inter,system-ui,sans-serif}
  .wrap{display:grid;grid-template-columns:2fr 1fr;gap:16px;padding:16px;box-sizing:border-box;max-width:100vw;overflow:hidden}
  .panel{background:var(--panel);border:1px solid var(--bd);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5);display:flex;flex-direction:column;min-height:70vh;overflow:hidden}
  .ph{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-bottom:1px solid var(--bd)}
  .pt{font-weight:700;letter-spacing:.3px}
  .pc{flex:1;min-height:0;display:flex;flex-direction:column}
  /* chart */
  #chartBox{position:relative;flex:0 0 auto;height:60vh;min-height:360px;max-height:70vh;padding:16px;overflow:hidden}
  #chartCanvas{display:block;width:100% !important;height:100% !important}
  /* right panel */
  .right-top{display:grid;grid-template-columns:auto 1fr;gap:12px;padding:12px 16px;border-bottom:1px solid var(--bd)}
  .wheelThumb{width:82px;height:82px;object-fit:contain;animation:spin 15s linear infinite}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .balanceLine{display:flex;flex-direction:column;gap:4px;font-size:14px;color:var(--txt)}
  .tokenName{color:var(--gold);font-weight:700}
  .usd{font-weight:700}
  .usd.green{color:var(--green)} .usd.gold{color:var(--gold)} .usd.red{color:var(--red)}
  .row{padding:10px 16px;border-bottom:1px solid var(--bd)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .copy{margin-left:6px;cursor:pointer}
  /* manage tokens */
  .tok{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border:1px solid var(--bd);border-radius:12px;margin:8px 0}
  .tag{padding:4px 10px;border-radius:999px;font-size:12px;border:2px solid #334;border-color:#334;color:#9bd;display:inline-block;margin-right:10px}
  .tag.on{border-color:#2d7f3a;color:#bdf0c7}
  .tag.off{border-color:#7a2323;color:#ffb4b4}
  .tokLeft{display:flex;flex-direction:column;gap:6px;overflow:hidden}
  .tokName{font-size:20px;font-weight:800;color:var(--gold)}
  .tokAddr{font-size:13px;color:var(--muted);word-break:break-all}
  .tokBtns button{background:#111;border:1px solid #444;color:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
  .tokBtns button:hover{border-color:#666}
  .addRow{display:flex;gap:10px;margin-top:8px}
  .addRow input{flex:1;background:#111;border:1px solid #333;border-radius:12px;color:#fff;padding:10px}
  .addRow button{background:#111;border:1px solid #444;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
  /* leaderboard */
  .lbWrap{flex:1;min-height:0;display:flex;flex-direction:column}
  .lbHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-top:1px solid var(--bd)}
  .table{flex:1;min-height:0;overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px 10px;border-bottom:1px solid #1c1c1e;text-align:left}
  th{position:sticky;top:0;background:#101014}
  .error{color:#fb7185;padding:8px 16px}
  @media (max-width: 1100px){ .wrap{grid-template-columns:1fr; } }
</style>
</head>
<body>
<div class="wrap">
  <!-- Left: Chart -->
  <section class="panel">
    <div class="ph"><div class="pt" id="chartTitle">Server â€¢ Performance (All tokens)</div>
      <div>
        <select id="rangeSelect" style="background:#111;color:#fff;border:1px solid #333;border-radius:10px;padding:6px 10px">
          <option value="past30">Past 30 days</option>
          <option value="all">All time</option>
        </select>
      </div>
    </div>
    <div class="pc"><div id="chartBox"><canvas id="chartCanvas"></canvas></div></div>
  </section>

  <!-- Right: Admin panel -->
  <aside class="panel">
    <div class="ph"><div class="pt">Admin Panel</div></div>

    <!-- top: wheel + balances -->
    <div class="right-top">
      <img id="wheelThumb" class="wheelThumb" alt="Wheel"/>
      <div class="balanceLine">
        <div><span class="tokenName" id="spinName">â€”</span> : <span id="spinQty">â€”</span> / <span id="spinUsd" class="usd">â€”</span></div>
        <div><span class="tokenName" id="gasName">â€”</span> : <span id="gasQty">â€”</span> / <span id="gasUsd" class="usd">â€”</span></div>
      </div>
    </div>

    <div class="row"><span class="mono">Wallet:</span> <span class="mono" id="poolAddr">â€”</span>
      <span class="copy" id="copyAddr" title="Copy">ðŸ“‹</span>
    </div>

    <div class="row">
      <div class="pt" style="margin-bottom:8px">Manage Token Types</div>
      <div id="tokenList"></div>
      <div class="addRow">
        <input id="newToken" placeholder="New token mint address (contract_address)"/>
        <button id="addBtn">Add Token</button>
      </div>
      <div id="tokHint" style="color:#fbbf24;margin-top:6px;font-size:12px;display:none"></div>
    </div>

    <div class="lbWrap">
      <div class="lbHeader">
        <div class="pt" style="font-size:16px">Leaderboards (Top 200)</div>
        <div>
          <label style="font-size:12px;margin-right:6px">Sort by</label>
          <select id="lbSort" style="background:#111;color:#fff;border:1px solid #333;border-radius:10px;padding:6px 10px">
            <option value="spins">Spins</option>
            <option value="payout">Payout</option>
          </select>
        </div>
      </div>
      <div id="lbError" class="error" style="display:none"></div>
      <div class="table"><table id="lbTable">
        <thead><tr><th>#</th><th>User</th><th>Spins</th><th>Payout</th></tr></thead>
        <tbody></tbody>
      </table></div>
    </div>
  </aside>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const urlq = new URLSearchParams(location.search);
const token = urlq.get('token'); const server_id = urlq.get('server_id');
let contract_address = null, token_name = null, image_url = null;
let chartInstance = null;

function usdClass(v){
  const n = Number(v?.toString().replace(/[^0-9.]/g,'')); if (isNaN(n)) return '';
  if (n >= 50) return 'green'; if (n >= 20) return 'gold'; return 'red';
}

async function readJsonSafe(res){
  const text = await res.text();
  try { return { ok:true, json: JSON.parse(text) }; }
  catch { return { ok:false, text }; }
}

async function fetchSpinConfig(){
  const res = await fetch('/api/spin', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ token, server_id })
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'config error');
  const info = data.adminInfo || {};
  token_name = data.tokenConfig?.token_name || 'Token';
  image_url = data.tokenConfig?.image_url || '';
  contract_address = data.contract_address;

  $('spinName').textContent = token_name;
  $('gasName').textContent = (info.gasSymbol || 'SOL');
  $('spinQty').textContent = (typeof info.tokenAmt === 'number') ? info.tokenAmt.toLocaleString(undefined,{maximumFractionDigits:6}) : (info.tokenAmt ?? 'N/A');
  $('gasQty').textContent = (typeof info.gasAmt === 'number') ? info.gasAmt.toFixed(4) : (info.gasAmt ?? 'N/A');
  $('spinUsd').textContent = info.tokenUsdValue ? `$${info.tokenUsdValue}` : 'â€”';
  $('gasUsd').textContent  = info.gasUsdValue  ? `$${info.gasUsdValue}`  : 'â€”';
  $('spinUsd').className = 'usd ' + usdClass(info.tokenUsdValue);
  $('gasUsd').className  = 'usd ' + usdClass(info.gasUsdValue);

  $('poolAddr').textContent = info.poolAddr || 'â€”';
  $('copyAddr').onclick = ()=>{ if(info.poolAddr){ navigator.clipboard.writeText(info.poolAddr); } };

  if (image_url) { $('wheelThumb').src = image_url; $('wheelThumb').style.display = 'block'; }
  else { $('wheelThumb').style.display = 'none'; }
}

function tokenRow(item){
  const name = item.token_name || (item.contract_address ? (item.contract_address.slice(0,4)+'â€¦'+item.contract_address.slice(-4)) : 'Token');
  const addr = item.contract_address || 'â€”';
  const tag = item.enabled ? `<span class="tag on">ENABLED</span>` : `<span class="tag off">DISABLED</span>`;
  const btnLabel = item.enabled ? 'Disable' : 'Re-enable';
  return `
    <div class="tok" data-addr="${addr}">
      <div class="tokLeft">
        <div>${tag} <span class="tokName">${name}</span></div>
        <div class="tokAddr mono">${addr}</div>
      </div>
      <div class="tokBtns">
        <button class="toggleBtn">${btnLabel}</button>
      </div>
    </div>`;
}

async function loadTokens(){
  const res = await fetch('/api/admin/tokens', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ token, server_id, action:'list' })
  });
  const data = await res.json();
  const list = $('tokenList'); list.innerHTML='';
  if (!res.ok){ list.innerHTML = `<div class="error">${data.error || 'Error'}</div>`; return; }

  const needs = (data.items||[]).some(it=>it.missingEnabled);
  $('tokHint').style.display = needs ? 'block' : 'none';
  $('tokHint').textContent = needs ? "Toggling requires an enabled boolean column on server_tokens. Run once: ALTER TABLE server_tokens ADD COLUMN enabled boolean DEFAULT true;" : '';

  (data.items || []).forEach(it => { list.insertAdjacentHTML('beforeend', tokenRow(it)); });
  // handlers
  list.querySelectorAll('.toggleBtn').forEach(btn => {
    btn.onclick = async (e) => {
      const row = e.target.closest('.tok');
      const addr = row.getAttribute('data-addr');
      const r = await fetch('/api/admin/tokens', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ token, server_id, action:'toggle', contract_address: addr })
      });
      const j = await r.json();
      if (!r.ok){
        if (j.error === 'missing-enabled') alert(j.hint || 'Add enabled column first.');
        else alert(j.error || 'Toggle failed');
        return;
      }
      await loadTokens();
    };
  });
  $('addBtn').onclick = async ()=>{
    const addr = ($('newToken').value || '').trim();
    if (!addr) return;
    const r = await fetch('/api/admin/tokens', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ token, server_id, action:'add', contract_address: addr })
    });
    const j = await r.json();
    if (!r.ok){ alert(j.error || 'Add failed'); return; }
    $('newToken').value = '';
    await loadTokens();
  };
}

async function loadLeaderboards(sortBy='spins'){
  const res = await fetch('/api/adminleaderboards', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ token, server_id })
  });
  const parsed = await readJsonSafe(res);
  const tb = $('lbTable').querySelector('tbody');
  tb.innerHTML = '';
  $('lbError').style.display = 'none';

  if (!parsed.ok) {
    $('lbError').textContent = `API error: ${parsed.text.slice(0,120)}`;
    $('lbError').style.display = 'block';
    return;
  }
  const data = parsed.json;
  const rows = (sortBy==='payout' ? data.byPayout : data.bySpins) || [];
  rows.forEach((r) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.rank}</td><td>${r.user}</td><td>${r.spins}</td><td>${r.payout}</td>`;
    tb.appendChild(tr);
  });
}

async function loadChart(range='past30'){
  // NOTE: aggregated server-wide chart (no contract_address sent)
  const res = await fetch('/api/chart', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ token, server_id, range })
  });
  const payload = await res.json();
  if (!res.ok) { alert(payload.error || 'chart error'); return; }
  const ctx = $('chartCanvas').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type:'line',
    data: payload.chartData,
    options: Object.assign({
      responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
      plugins:{ legend:{ labels:{ color:'#ddd' } } },
      scales:{
        x:{ ticks:{ color:'#bbb' }, grid:{ color:'rgba(255,255,255,.05)' } },
        y:{ ticks:{ color:'#bbb' },  grid:{ color:'rgba(255,255,255,.05)' }, title:{ display:true, text:'# Spins', color:'#bbb' } },
        y1:{ position:'right', ticks:{ color:'#bbb' }, grid:{ drawOnChartArea:false }, title:{ display:true, text:'Avg Payout', color:'#bbb' } }
      }
    }, payload.options || {})
  });
}

(async function init(){
  if (!token || !server_id){ alert('Missing token/server_id'); return; }

  await fetchSpinConfig();
  $('chartTitle').textContent = 'Server â€¢ Performance (All tokens)';
  $('rangeSelect').onchange = (e)=> loadChart(e.target.value);
  await loadChart('past30');
  await loadTokens();
  await loadLeaderboards('spins');
  $('lbSort').onchange = (e)=> loadLeaderboards(e.target.value);
})();
</script>
</body>
</html>
