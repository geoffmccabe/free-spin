<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0b0b0c;--panel:#121214;--panel2:#151517;--border:#1f1f20;--muted:#999;--txt:#eaeaea;--gold:#f0c44a;--green:#12c27a;--red:#e24d4d}
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
    .wrap{padding:12px}
    .row{display:grid;grid-template-columns:1fr 420px;gap:16px}
    @media (max-width:1100px){.row{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));font-size:16px}
    .card .body{padding:12px 14px}
    .flex{display:flex;align-items:center;gap:10px}
    .right-head{display:flex;align-items:center;gap:10px;justify-content:flex-end;padding-right:10px}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:#ddd;background:#0f0f10}
    .pill.ok{border-color:#164c2e;color:#9ff2c4;background:#0b1b13}
    .pill.bad{border-color:#5a2222;color:#f2a7a7;background:#1b0c0c}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .sub{color:#bbb;font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .stat{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px}
    .stat b{color:#fff}
    .usd{font-weight:700}
    .usd.green{color:var(--green)} .usd.gold{color:var(--gold)} .usd.red{color:var(--red)}
    .iconbtn{background:#202022;border:1px solid #353536;color:#ddd;border-radius:10px;padding:6px 10px;cursor:pointer}
    .wheel-mini{width:56px;height:56px;border-radius:50%;object-fit:cover;animation:spin 15s linear infinite;filter:drop-shadow(0 6px 16px rgba(0,0,0,.5))}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .toolbar{display:flex;gap:8px;align-items:center}
    select{background:#151517;border:1px solid #333;color:#eee;border-radius:10px;padding:6px 10px}
    .chart-wrap{position:relative;height:64vh;min-height:420px}
    .leg{display:flex;align-items:center;gap:8px;margin-left:auto}
    .legend-dot{width:10px;height:10px;border-radius:50%}
    .table{width:100%;border-collapse:collapse;color:#ddd}
    .table th,.table td{padding:8px;border-bottom:1px solid #1b1b1c;font-size:13px}
    .table th{color:#aaa;text-align:left}
    .scroll{max-height:62vh;overflow:auto}
    .hint{color:#bbb;font-size:12px;margin-top:8px}
    .banner{background:#1b1b1c;border:1px solid #2a2a2d;color:#ddd;border-radius:12px;padding:10px;margin:0 0 12px}
    .hide{display:none}
  </style>
</head>
<body>
<div class="wrap">
  <div id="warn" class="banner hide"></div>
  <div class="row">
    <!-- Left: Performance -->
    <div class="card">
      <h2 class="flex">
        <span id="title">Performance</span>
        <div class="leg">
          <div class="legend-dot" style="background:#4aa3ff"></div><span class="sub">Spins</span>
          <div class="legend-dot" style="background:#ff5c87"></div><span class="sub">Total Payout</span>
        </div>
        <div class="right-head">
          <div class="toolbar">
            <label class="sub">View</label>
            <select id="viewSelect">
              <option value="server">All tokens</option>
              <option value="token">This token</option>
            </select>
            <label class="sub">Range</label>
            <select id="rangeSelect">
              <option value="30d">Past 30 days</option>
              <option value="all">All time</option>
            </select>
          </div>
        </div>
      </h2>
      <div class="body">
        <div class="grid2" style="align-items:flex-start;gap:12px;margin-bottom:12px">
          <div class="stat" id="tokStat">
            <div class="flex" style="gap:12px">
              <img id="miniWheel" class="wheel-mini" alt="" style="display:none"/>
              <div>
                <div><b id="tokName">—</b> <span id="tokStatus" class="pill">no token supplied</span></div>
                <div class="sub mono" style="word-break:break-all" id="mintAddr">—</div>
              </div>
            </div>
            <div class="hint">Provide a token in the URL to see token balances.</div>
          </div>
          <div class="stat">
            <div style="display:grid;grid-template-columns:1fr auto;gap:6px">
              <div><b id="balTokenName">Token</b>: <span id="balTokenAmt">—</span> /
                <span id="balTokenUsd" class="usd">—</span></div>
              <div></div>
              <div><b>SOL</b>: <span id="balSolAmt">—</span> /
                <span id="balSolUsd" class="usd">—</span></div>
              <div class="flex" style="justify-self:end"><span class="sub mono" id="poolAddr">Wallet: —</span>
                <button class="iconbtn" id="copyAddr" title="Copy address">▦</button></div>
            </div>
            <div class="hint">Balances show for token view only.</div>
          </div>
        </div>
        <div class="chart-wrap"><canvas id="chart"></canvas></div>
      </div>
    </div>

    <!-- Right: Leaderboard -->
    <div class="card">
      <h2>Leaderboards (Top 200) <span class="sub" id="lbScope">(All tokens)</span></h2>
      <div class="body">
        <div class="toolbar" style="margin-bottom:10px">
          <label class="sub">Sort by</label>
          <select id="sortSelect">
            <option value="spins">Spins</option>
            <option value="payout">Payout</option>
          </select>
        </div>
        <div class="scroll">
          <table class="table" id="lbTable">
            <thead><tr><th>#</th><th>User</th><th>Spins</th><th>Payout</th></tr></thead>
            <tbody id="lbBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  // Try URL → sessionStorage → localStorage → referrer
  const fromRef = () => {
    try { return new URL(document.referrer).searchParams } catch { return null }
  };
  let token = qs.get('token')
    || sessionStorage.getItem('solspin_token')
    || localStorage.getItem('solspin_token')
    || (fromRef() && fromRef().get('token')) || null;

  let server_id = qs.get('server_id')
    || sessionStorage.getItem('solspin_server_id')
    || localStorage.getItem('solspin_server_id')
    || (fromRef() && fromRef().get('server_id')) || null;

  if (token) sessionStorage.setItem('solspin_token', token);
  if (server_id) sessionStorage.setItem('solspin_server_id', server_id);

  const warn = document.getElementById('warn');

  const el = (id) => document.getElementById(id);
  const title=el('title'), miniWheel=el('miniWheel'), tokName=el('tokName'),
        mintAddr=el('mintAddr'), tokStatus=el('tokStatus'),
        balTokenName=el('balTokenName'), balTokenAmt=el('balTokenAmt'),
        balTokenUsd=el('balTokenUsd'), balSolAmt=el('balSolAmt'),
        balSolUsd=el('balSolUsd'), poolAddr=el('poolAddr'),
        copyAddr=el('copyAddr'), lbScope=el('lbScope'), tokStat=el('tokStat');

  const viewSelect=el('viewSelect'), rangeSelect=el('rangeSelect'), sortSelect=el('sortSelect');

  let contract_address=null, token_sym=null, image_url=null;
  let chart=null;

  function usdClass(val){
    if (typeof val !== 'number') return '';
    if (val>=50) return 'usd green';
    if (val>=20) return 'usd gold';
    return 'usd red';
  }

  function needServer(){
    if (!server_id){
      warn.classList.remove('hide');
      warn.textContent = 'Missing server_id. Open Admin from the wheel page so the link includes ?token=...&server_id=....';
      return true;
    }
    warn.classList.add('hide');
    return false;
  }

  async function loadConfigIfToken(){
    if (!token) {
      // No token → server view only
      viewSelect.value = 'server';
      tokStatus.textContent = 'no token supplied';
      tokStatus.className = 'pill';
      tokName.textContent = '—';
      mintAddr.textContent = '—';
      miniWheel.style.display='none';
      return;
    }

    try{
      const r = await fetch('/api/spin', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ token, server_id })
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j.error||'config failed');

      const tcfg = j.tokenConfig || {};
      token_sym = tcfg.token_name || 'Token';
      image_url = tcfg.image_url || '';
      contract_address = j.contract_address || null;

      title.textContent = `${token_sym} • Performance`;
      tokName.textContent = token_sym;
      balTokenName.textContent = token_sym;
      mintAddr.textContent = contract_address || '—';
      tokStatus.textContent = 'ENABLED';
      tokStatus.className = 'pill ok';

      if (image_url){
        const img=new Image();
        img.onload=()=>{ miniWheel.src=image_url; miniWheel.style.display='block'; };
        img.onerror=()=>{ miniWheel.style.display='none'; };
        img.src=image_url;
      } else miniWheel.style.display='none';

      const info = j.adminInfo || {};
      poolAddr.textContent = `Wallet: ${info.poolAddr || '—'}`;
      copyAddr.onclick = () => { if (info.poolAddr) navigator.clipboard.writeText(info.poolAddr); };

      const tokAmt = Number(info.tokenAmt ?? NaN);
      const tokUsd = Number(info.tokenUsdValue ?? NaN);
      const solAmt = Number(info.gasAmt ?? NaN);
      const solUsd = Number(info.gasUsdValue ?? NaN);

      balTokenAmt.textContent = Number.isFinite(tokAmt) ? tokAmt.toLocaleString(undefined,{maximumFractionDigits:6}) : '—';
      balTokenUsd.textContent = Number.isFinite(tokUsd) ? `$${tokUsd.toLocaleString()}` : '—';
      balTokenUsd.className = usdClass(tokUsd)||'usd';

      balSolAmt.textContent   = Number.isFinite(solAmt) ? solAmt.toLocaleString(undefined,{maximumFractionDigits:6}) : '—';
      balSolUsd.textContent   = Number.isFinite(solUsd) ? `$${solUsd.toLocaleString()}` : '—';
      balSolUsd.className     = usdClass(solUsd)||'usd';

      // If we have a token, default to token view
      viewSelect.value = 'token';
      lbScope.textContent = '(This token)';
      tokStat.querySelector('.hint').textContent = 'Token balances shown below.';
    }catch(e){
      // Fall back to server view if token rejected (used/expired)
      viewSelect.value = 'server';
      lbScope.textContent = '(All tokens)';
      tokStatus.textContent = 'token invalid/used';
      tokStatus.className = 'pill bad';
      miniWheel.style.display='none';
    }
  }

  function datesBetween(startISO, endISO){
    const s=new Date(startISO), e=new Date(endISO), out=[];
    s.setUTCHours(0,0,0,0); e.setUTCHours(0,0,0,0);
    while (s<=e){ out.push(s.toISOString().slice(0,10)); s.setUTCDate(s.getUTCDate()+1); }
    return out;
  }

  async function loadChart(){
    if (needServer()) return;

    const view = viewSelect.value;
    const range= rangeSelect.value;
    lbScope.textContent = view==='token' ? '(This token)' : '(All tokens)';

    const body = { server_id, view, range };
    if (view==='token' && contract_address) body.contract_address = contract_address;

    const r = await fetch('/api/chart', {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    const j = await r.json();
    if(!r.ok){ warn.classList.remove('hide'); warn.textContent = j.error||'Chart failed'; return; }

    const { labels, spins, totalPayout, yMaxLeft, yMaxRight } = j;
    const ctx = document.getElementById('chart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type:'line',
      data:{
        labels,
        datasets:[
          {label:'Spins', data:spins, yAxisID:'y', borderColor:'#4aa3ff', backgroundColor:'rgba(74,163,255,.15)', tension:.25, fill:true, pointRadius:0},
          {label:'Total Payout', data:totalPayout, yAxisID:'y1', borderColor:'#ff5c87', backgroundColor:'rgba(255,92,135,.15)', tension:.25, fill:true, pointRadius:0}
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        interaction:{mode:'index', intersect:false},
        plugins:{legend:{labels:{color:'#ddd'}}, tooltip:{enabled:true}},
        scales:{
          x:{ticks:{color:'#aaa', maxRotation:60, minRotation:40}, grid:{color:'rgba(255,255,255,.05)'}},
          y:{title:{display:true,text:'# Spins',color:'#bbb'}, ticks:{color:'#bbb'}, grid:{color:'rgba(255,255,255,.05)'}, suggestedMax:yMaxLeft||undefined},
          y1:{position:'right', title:{display:true,text:'Total Payout',color:'#bbb'}, ticks:{color:'#bbb'}, grid:{drawOnChartArea:false}, suggestedMax:yMaxRight||undefined}
        }
      }
    });
  }

  function renderLB(rows){
    const tbody = document.getElementById('lbBody');
    tbody.innerHTML = '';
    rows.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.name||r.discord_id}</td><td>${r.spins}</td><td>${r.payout}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function loadLB(){
    if (needServer()) return;

    const view = viewSelect.value;
    const sort = sortSelect.value;
    const body = { server_id, sort, view, range: rangeSelect.value };
    if (view==='token' && contract_address) body.contract_address = contract_address;

    const r = await fetch('/api/adminleaderboards', {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    const j = await r.json();
    if(!r.ok){ warn.classList.remove('hide'); warn.textContent = j.error||'Leaderboards failed'; return; }
    renderLB(j.rows||[]);
  }

  // Events
  viewSelect.addEventListener('change', () => { loadChart(); loadLB(); });
  rangeSelect.addEventListener('change', () => { loadChart(); loadLB(); });
  sortSelect.addEventListener('change',  () => { loadLB(); });

  (async () => {
    if (needServer()) return;
    await loadConfigIfToken();   // will pick token view if valid, else server view
    await loadChart();
    await loadLB();
  })().catch(e=>{ warn.classList.remove('hide'); warn.textContent = e.message });
})();
</script>
</body>
</html>
