<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin • Spin</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:Inter,system-ui,Arial,sans-serif}
  .page{min-height:100%;display:grid;grid-template-columns:1.2fr 1fr;gap:14px;padding:14px;box-sizing:border-box}
  @media (max-width: 1100px){ .page{grid-template-columns:1fr;grid-auto-rows:max-content} }

  /* Left: Chart panel */
  .panel{background:#0b0b0c;border:1px solid #1f1f20;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5);display:flex;flex-direction:column;min-height:60vh}
  .panel-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-bottom:1px solid #1c1c1e}
  .panel-title{font-weight:700}
  .panel-body{flex:1;min-height:300px;position:relative;padding:12px 16px}
  #chartCanvas{width:100%;height:100%}
  .toolbar{display:flex;align-items:center;gap:8px}
  .toolbar select{background:#111;color:#fff;border:1px solid #333;border-radius:10px;padding:6px 10px}
  .back{background:#222;border:1px solid #444;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none}

  @keyframes slowspin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  #chart-wheel{position:absolute;left:16px;bottom:16px;width:140px;height:140px;animation:slowspin 15s linear infinite;filter:drop-shadow(0 8px 20px rgba(0,0,0,.5));display:none}

  /* Right: Admin panel */
  .admin{background:#0b0b0c;border:1px solid #1f1f20;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5);display:flex;flex-direction:column}
  .admin-sec{border-top:1px solid #1c1c1e;padding:12px 16px}
  .admin-sec:first-child{border-top:none}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .token-name{color:#d4af37;font-weight:800}
  .usd{font-weight:700}
  .usd-high{color:#22c55e}.usd-mid{color:#f59e0b}.usd-low{color:#ef4444}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:13px}
  .copy-icon{margin-left:8px;display:inline-flex;vertical-align:middle;cursor:pointer}
  .copy-icon svg{width:16px;height:16px}
  .copy-copied rect{stroke:#22c55e!important}

  /* Manage Token Types */
  #token-list{display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto}
  .token-item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;background:#0f0f10;border:1px solid #1f1f20;border-radius:10px}
  .token-item .meta{display:flex;gap:10px;align-items:center}
  .badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #2a2a2c;background:#141416;opacity:.9}
  .token-item button{padding:6px 10px;font-size:12px;border-radius:10px;border:1px solid #2a2a2c;background:#1a1a1c;color:#fff;cursor:pointer}
  .token-add{display:flex;gap:8px;margin-top:10px}
  .token-add input{flex:1;min-width:0;background:#111;color:#fff;border:1px solid #333;border-radius:10px;padding:8px 10px;font-size:12px}

  /* Leaderboards */
  .lb-head{display:flex;justify-content:space-between;align-items:center}
  .lb-controls select{background:#111;color:#fff;border:1px solid #333;border-radius:10px;padding:6px 10px}
  .lb-table{max-height:420px;overflow:auto;border:1px solid #1f1f20;border-radius:10px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #151517;font-size:12px;text-align:left}
  th{position:sticky;top:0;background:#121214;z-index:1}
  tr:last-child td{border-bottom:none}
  .lb-table::-webkit-scrollbar{width:10px}
  .lb-table::-webkit-scrollbar-track{background:#0f0f10}
  .lb-table::-webkit-scrollbar-thumb{background:#2a2a2c;border-radius:10px}
  .lb-table::-webkit-scrollbar-thumb:hover{background:#3a3a3d}
</style>
</head>
<body>
  <div class="page">
    <!-- Left: Chart -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title" id="chart-title">Token Performance</div>
        <div class="toolbar">
          <label for="rangeSelect">Range</label>
          <select id="rangeSelect">
            <option value="past30">Past 30 days</option>
            <option value="all">All time</option>
          </select>
          <a class="back" id="backLink">Back to Wheel</a>
        </div>
      </div>
      <div class="panel-body">
        <canvas id="chartCanvas"></canvas>
        <img id="chart-wheel" alt="Wheel">
      </div>
    </section>

    <!-- Right: Admin panel -->
    <aside class="admin" id="admin-panel">
      <div class="admin-sec">
        <h3 style="margin:0 0 8px 0">Admin Panel</h3>
        <div class="row">
          <span class="token-name" id="spin-name">—</span>:
          <span id="spin-qty">—</span> /
          <span class="usd" id="spin-usd">$—</span>
        </div>
        <div class="row" style="margin-top:6px">
          <span class="token-name" id="gas-name">—</span>:
          <span id="gas-qty">—</span> /
          <span class="usd" id="gas-usd">$—</span>
        </div>
      </div>

      <div class="admin-sec">
        <div class="row" style="align-items:center">
          <span class="mono" id="pool-addr">Wallet: —</span>
          <span class="copy-icon" id="copy-icon" title="Copy address">
            <svg viewBox="0 0 24 24" fill="none">
              <rect x="7" y="7" width="12" height="12" rx="2" stroke="#bbb" />
              <rect x="4" y="4" width="12" height="12" rx="2" stroke="#bbb" />
            </svg>
          </span>
        </div>
      </div>

      <div class="admin-sec" id="superadmin-controls" style="display:none;">
        <h4 style="margin:0 0 8px 0">Manage Token Types</h4>
        <div id="token-list"></div>
        <div class="token-add">
          <input type="text" id="new-token-contract" placeholder="New token mint address (contract_address)">
          <button id="add-token-btn">Add Token</button>
        </div>
      </div>

      <div class="admin-sec">
        <div class="lb-head">
          <h4 style="margin:0">Leaderboards (Top 200)</h4>
          <div class="lb-controls">
            <label for="lbMode">Sort by</label>
            <select id="lbMode">
              <option value="spins">Spins</option>
              <option value="payout">Payout</option>
            </select>
          </div>
        </div>
        <div class="lb-table">
          <table>
            <thead><tr><th>#</th><th>User</th><th>Spins</th><th>Payout</th></tr></thead>
            <tbody id="lb-body"><tr><td colspan="4" class="mono" style="opacity:.8">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>
    </aside>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const token = qs.get('token');
  const server_id = qs.get('server_id');
  if (!token || !server_id) {
    alert('Missing token or server_id');
    return;
  }
  const backLink = document.getElementById('backLink');
  backLink.href = `index.html?token=${encodeURIComponent(token)}&server_id=${encodeURIComponent(server_id)}`;

  // Admin panel refs
  const spinNameEl = document.getElementById('spin-name');
  const spinQtyEl  = document.getElementById('spin-qty');
  const spinUsdEl  = document.getElementById('spin-usd');
  const gasNameEl  = document.getElementById('gas-name');
  const gasQtyEl   = document.getElementById('gas-qty');
  const gasUsdEl   = document.getElementById('gas-usd');
  const poolAddrEl = document.getElementById('pool-addr');
  const copyIcon   = document.getElementById('copy-icon');

  const superControls = document.getElementById('superadmin-controls');
  const tokenListEl   = document.getElementById('token-list');
  const addTokenBtn   = document.getElementById('add-token-btn');
  const newTokenInput = document.getElementById('new-token-contract');

  // Leaderboards
  const lbMode  = document.getElementById('lbMode');
  const lbBody  = document.getElementById('lb-body');

  // Chart
  const chartCanvas = document.getElementById('chartCanvas');
  const chartWheel  = document.getElementById('chart-wheel');
  const chartTitle  = document.getElementById('chart-title');
  const rangeSelect = document.getElementById('rangeSelect');
  let chartInstance = null;
  let contract_address = null;
  let token_name = null;
  let image_url = null;

  function usdClass(val) {
    const n = typeof val === 'string' ? Number(val.replace(/[^0-9.]/g,'')) : Number(val);
    if (!Number.isFinite(n)) return '';
    if (n >= 50) return 'usd-high';
    if (n >= 20) return 'usd-mid';
    return 'usd-low';
  }

  async function init() {
    // Use /api/spin (no spin) to get role, adminInfo, token config
    const res = await fetch('/api/spin', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ token, server_id })
    });
    const data = await res.json();
    if (!res.ok) {
      alert(data.error || 'Access denied');
      return;
    }

    const role = data.role || null;
    if (role !== 'admin' && role !== 'superadmin') {
      alert('Admins only.');
      location.href = `index.html?token=${encodeURIComponent(token)}&server_id=${encodeURIComponent(server_id)}`;
      return;
    }

    const info = data.adminInfo || {};
    token_name = data?.tokenConfig?.token_name || 'Token';
    contract_address = data.contract_address || null;
    image_url = data?.tokenConfig?.image_url || null;

    // Admin balances
    spinNameEl.textContent = info.tokenSymbol || token_name || '—';
    spinQtyEl.textContent  = (typeof info.tokenAmt === 'number') ? info.tokenAmt.toLocaleString(undefined,{ maximumFractionDigits: 6 }) : String(info.tokenAmt ?? 'N/A');
    const tokUsd = (typeof info.tokenUsdValue === 'number') ? info.tokenUsdValue.toFixed(2) : String(info.tokenUsdValue ?? 'N/A');
    spinUsdEl.textContent = `$${tokUsd}`; spinUsdEl.className = `usd ${usdClass(tokUsd)}`;

    gasNameEl.textContent = info.gasSymbol || 'SOL';
    gasQtyEl.textContent  = (typeof info.gasAmt === 'number') ? info.gasAmt.toFixed(4) : String(info.gasAmt ?? 'N/A');
    const gasUsd = (typeof info.gasUsdValue === 'number') ? info.gasUsdValue.toFixed(2) : String(info.gasUsdValue ?? 'N/A');
    gasUsdEl.textContent = `$${gasUsd}`; gasUsdEl.className = `usd ${usdClass(gasUsd)}`;

    poolAddrEl.textContent = `Wallet: ${info.poolAddr || '—'}`;
    copyIcon.onclick = () => {
      if (!info.poolAddr) return;
      navigator.clipboard.writeText(info.poolAddr);
      copyIcon.classList.add('copy-copied');
      setTimeout(() => copyIcon.classList.remove('copy-copied'), 1000);
    };

    // Superadmin features
    if (role === 'superadmin') {
      superControls.style.display = 'block';
      loadServerTokens();
      addTokenBtn.onclick = async () => {
        const mint = newTokenInput.value.trim();
        if (!mint) return;
        addTokenBtn.disabled = true;
        const resX = await fetch('/api/admin/tokens', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ token, server_id, action:'add', contract_address: mint })
        });
        addTokenBtn.disabled = false;
        if (resX.ok) { newTokenInput.value=''; loadServerTokens(); } else { alert('Failed to add token'); }
      };
    }

    // Chart
    chartTitle.textContent = `${token_name} • Performance`;
    if (image_url) {
      chartWheel.onload = () => { chartWheel.style.display = 'block'; };
      chartWheel.onerror = () => { chartWheel.style.display = 'none'; };
      chartWheel.src = image_url;
    }
    await loadChart('past30');

    // Leaderboards
    await loadLeaderboards();
    lbMode.addEventListener('change', renderLeaderboard);

    // Range change
    rangeSelect.addEventListener('change', (e)=> loadChart(e.target.value));
  }

  async function loadChart(range) {
    const res = await fetch('/api/chart', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ token, server_id, contract_address, range })
    });
    const payload = await res.json();
    if (!res.ok) { alert(payload.error || 'Failed to load chart'); return; }

    if (chartInstance) chartInstance.destroy();
    const ctx = chartCanvas.getContext('2d');
    chartInstance = new Chart(ctx, {
      type:'line',
      data: payload.chartData,
      options: Object.assign({
        responsive:true, maintainAspectRatio:false,
        interaction:{ mode:'index', intersect:false },
        plugins:{ legend:{ labels:{ color:'#ddd' } }, tooltip:{ enabled:true } },
        scales:{
          x:{ ticks:{ color:'#bbb' }, grid:{ color:'rgba(255,255,255,0.05)' } },
          y:{ ticks:{ color:'#bbb' }, grid:{ color:'rgba(255,255,255,0.05)' }, title:{ display:true, text:'# Spins', color:'#bbb' } },
          y1:{ position:'right', ticks:{ color:'#bbb' }, grid:{ drawOnChartArea:false }, title:{ display:true, text:'Payout Amount', color:'#bbb' } }
        }
      }, payload.options || {})
    });
  }

  async function loadServerTokens() {
    tokenListEl.innerHTML = '<div class="mono" style="opacity:.7">Loading tokens…</div>';
    try {
      const res = await fetch('/api/admin/tokens', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ token, server_id, action:'list' })
      });
      const payload = await res.json();
      if (!res.ok) { tokenListEl.innerHTML = `<div class="mono" style="color:#f66">Error: ${payload.error || 'failed to load'}</div>`; return; }
      const rows = payload.tokens || [];
      if (!rows.length) { tokenListEl.innerHTML = '<div class="mono" style="opacity:.7">No tokens added yet.</div>'; return; }
      tokenListEl.innerHTML = '';
      rows.forEach(row=>{
        const el = document.createElement('div');
        el.className = 'token-item';
        el.innerHTML = `
          <div class="meta">
            <span class="badge">ENABLED</span>
            <span class="token-name">${row.token_name || 'Token'}</span>
            <span class="mono" style="opacity:.8">${row.contract_address}</span>
          </div>
          <div><button data-contract="${row.contract_address}">Disable</button></div>
        `;
        el.querySelector('button').onclick = async () => {
          const btn = el.querySelector('button'); btn.disabled = true;
          const res2 = await fetch('/api/admin/tokens', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ token, server_id, action:'setEnabled', contract_address: row.contract_address, enabled:false })
          });
          btn.disabled = false;
          if (res2.ok) loadServerTokens(); else alert('Failed to disable token');
        };
        tokenListEl.appendChild(el);
      });
    } catch(e) {
      tokenListEl.innerHTML = `<div class="mono" style="color:#f66">Error: ${e.message}</div>`;
    }
  }

  async function loadLeaderboards() {
    lbBody.innerHTML = `<tr><td colspan="4" class="mono" style="opacity:.8">Loading…</td></tr>`;
    try {
      const res = await fetch('/api/leaderboards', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ token, server_id })
      });
      const payload = await res.json();
      if (!res.ok) { lbBody.innerHTML = `<tr><td colspan="4" class="mono" style="color:#f66">Error: ${payload.error || 'failed to load'}</td></tr>`; return; }
      window._LB = payload;
      renderLeaderboard();
    } catch(e) {
      lbBody.innerHTML = `<tr><td colspan="4" class="mono" style="color:#f66">Error: ${e.message}</td></tr>`;
    }
  }
  function renderLeaderboard() {
    const mode = lbMode.value;
    const rows = (window._LB && (mode === 'spins' ? window._LB.bySpins : window._LB.byPayout)) || [];
    if (!rows.length) { lbBody.innerHTML = `<tr><td colspan="4" class="mono" style="opacity:.8">No data yet.</td></tr>`; return; }
    lbBody.innerHTML = rows.map(r => `<tr><td>${r.rank}</td><td>${r.user}</td><td>${r.spins}</td><td>${r.payout}</td></tr>`).join('');
  }

  init().catch(e=>alert(e.message));
})();
</script>
</body>
</html>
