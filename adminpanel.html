<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Admin Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html,body{background:#000;color:#fff;margin:0;font-family:Inter,system-ui,sans-serif;height:100vh;}
    .shell{display:grid;grid-template-columns: 2fr 1fr;grid-template-rows:auto 1fr;grid-template-areas:'hdr hdr' 'chart side';gap:14px;height:100vh;padding:14px;box-sizing:border-box;}
    .hdr{grid-area:hdr;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#0b0b0c;border:1px solid #1f1f20;border-radius:14px;}
    .title{font-weight:700}
    .row{display:flex;align-items:center;gap:10px}
    select,button{background:#111;color:#fff;border:1px solid #333;border-radius:10px;padding:6px 10px}
    .panel{background:#0b0b0c;border:1px solid #1f1f20;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,0.5);overflow:hidden}
    .chart{grid-area:chart;display:flex;flex-direction:column}
    .chart .body{position:relative;flex:1;min-height:360px;padding:10px 14px}
    .side{grid-area:side;display:flex;flex-direction:column;gap:14px;min-width:0}
    .minihead{padding:10px 14px;border-bottom:1px solid #1c1c1e;font-weight:600}
    .leader{display:flex;flex-direction:column;max-height:calc(100vh - 220px);overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 10px;border-bottom:1px solid #1c1c1e;text-align:left}
    th{position:sticky;top:0;background:#0b0b0c}
    .muted{color:#aaa}
    .thumbWrap{position:absolute;right:10px;top:10px;width:72px;height:72px;display:none}
    .thumbWrap img{width:72px;height:72px;animation:spin 15s linear infinite}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#d33;color:#fff;padding:10px 14px;border-radius:10px;display:none}
    @media (max-width: 900px){.shell{grid-template-columns:1fr;grid-template-rows:auto auto auto;grid-template-areas:'hdr' 'chart' 'side';height:auto}}
  </style>
</head>
<body>
  <div class="shell">
    <div class="hdr">
      <div class="title">Admin</div>
      <div class="row">
        <label>View</label>
        <select id="viewSelect">
          <option value="token">This token</option>
          <option value="server">Server (all tokens)</option>
        </select>
        <label>Range</label>
        <select id="rangeSelect">
          <option value="past30">Past 30 days</option>
          <option value="past7">Past 7 days</option>
          <option value="all">All time</option>
        </select>
      </div>
    </div>

    <div class="panel chart">
      <div class="minihead">Performance</div>
      <div class="body">
        <canvas id="chartCanvas"></canvas>
        <div class="thumbWrap" id="thumbWrap"><img id="wheelThumb" alt=""></div>
      </div>
    </div>

    <div class="panel side">
      <div class="minihead">
        Leaderboards (Top 200)
        <span class="muted" id="lbNote"></span>
      </div>
      <div class="row" style="padding:10px 14px;border-bottom:1px solid #1c1c1e">
        <label>Sort by</label>
        <select id="sortSelect">
          <option value="spins">Spins</option>
          <option value="payout">Payout</option>
        </select>
      </div>
      <div class="leader" id="leaderWrap">
        <table id="leaderTable">
          <thead><tr><th>#</th><th>User</th><th>Spins</th><th>Payout</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const qs = new URLSearchParams(location.search);
    const server_id = qs.get('server_id') || '';
    const contract_address = qs.get('contract_address') || '';
    const image_url = qs.get('image_url') || '';

    const toast = (msg) => {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(()=> el.style.display='none', 2500);
    };

    function ensureParams() {
      if (!server_id) {
        toast('server_id required');
        return false;
      }
      return true;
    }

    function showThumb() {
      if (!image_url) return;
      const w = document.getElementById('wheelThumb');
      const wrap = document.getElementById('thumbWrap');
      w.onload = () => { wrap.style.display = 'block'; };
      w.onerror = () => { wrap.style.display = 'none'; };
      w.src = image_url;
    }

    let chart;
    function drawChart(chartData, options) {
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, { type:'line', data:chartData, options });
    }

    async function loadChart() {
      const view = document.getElementById('viewSelect').value;
      const range = document.getElementById('rangeSelect').value;

      const payload = { server_id, range };
      if (view === 'token') {
        if (!contract_address) {
          toast('This token view requires contract_address');
          return;
        }
        payload.contract_address = contract_address;
      }

      const res = await fetch('/api/chart', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) { toast(data.error || 'Chart load failed'); return; }
      drawChart(data.chartData, data.options);

      const note = document.getElementById('lbNote');
      note.textContent = (view === 'token') ? ' (This token)' : ' (Server spins only)';
    }

    async function loadLeaderboards() {
      const sort_by = document.getElementById('sortSelect').value;
      // leaderboards are token-specific by design
      if (!contract_address) {
        document.querySelector('#leaderTable tbody').innerHTML = '';
        toast('contract_address required for leaderboards');
        return;
      }
      const res = await fetch('/api/adminleaderboards', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ server_id, contract_address, sort_by })
      });
      const data = await res.json();
      if (!res.ok) { toast(data.error || 'Leaderboards load failed'); return; }

      const tb = document.querySelector('#leaderTable tbody');
      tb.innerHTML = '';
      (data.items || []).forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td><td>${row.user || row.discord_id}</td><td>${row.spins}</td><td>${(row.payout ?? 0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>`;
        tb.appendChild(tr);
      });
    }

    // events
    document.getElementById('viewSelect').addEventListener('change', () => { loadChart(); });
    document.getElementById('rangeSelect').addEventListener('change', () => { loadChart(); });
    document.getElementById('sortSelect').addEventListener('change', () => { loadLeaderboards(); });

    // init
    (async function init(){
      if (!ensureParams()) return;
      showThumb();
      await loadChart();
      await loadLeaderboards();
    })();
  </script>
</body>
</html>
