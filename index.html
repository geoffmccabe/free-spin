<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Free Spin Wheel</title>
  <style>
    body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #000000; font-family: Arial, sans-serif; }
    #wheel-container { position: relative; text-align: center; }
    #wheel { width: 800px; height: 800px; }
    #spin-button { display: block; margin: 20px auto; padding: 15px 30px; font-size: 18px; background-color: #ff4500; color: white; border: none; border-radius: 10px; cursor: pointer; }
    #spin-button:disabled, #spin-button.hidden { display: none; }
    #error-message { color: red; font-size: 24px; font-weight: bold; margin-top: 20px; display: none; }
  </style>
</head>
<body>
  <div id="wheel-container">
    <img id="wheel" src="https://solspin.lightningworks.io/img/Wheel_Harold_800px.webp" alt="Spin Wheel">
    <button id="spin-button" disabled>SPIN</button>
    <div id="error-message"></div>
  </div>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    async function initWheel() {
      const spinButton = document.getElementById('spin-button');
      try {
        const response = await fetch('/api/spin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to load wheel');
        }

        const { tokenConfig } = data;
        document.getElementById('wheel').src = tokenConfig.image_url || 'https://solspin.lightningworks.io/img/Wheel_Harold_800px.webp';
        spinButton.disabled = false;
        spinButton.classList.remove('hidden');

        spinButton.onclick = async () => {
          spinButton.disabled = true;
          try {
            const spinResponse = await fetch('/api/spin', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token, spin: true })
            });
            const spinData = await spinResponse.json();

            if (!spinResponse.ok) {
              throw new Error(spinData.error || 'Spin failed');
            }

            const { segmentIndex, prize } = spinData;
            alert(`You won ${prize}!`);
          } catch (error) {
            document.getElementById('error-message').textContent = error.message === 'This spin token has already been used' || error.message === 'Daily spin limit reached' ? 'You have used all your free spins today' : error.message;
            document.getElementById('error-message').style.display = 'block';
            spinButton.classList.add('hidden');
          }
        };
      } catch (error) {
        document.getElementById('error-message').textContent = error.message === 'This spin token has already been used' || error.message === 'Daily spin limit reached' ? 'You have used all your free spins today' : error.message;
        document.getElementById('error-message').style.display = 'block';
        spinButton.classList.add('hidden');
      }
    }

    window.onload = initWheel;
  </script>
</body>
</html>
