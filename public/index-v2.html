<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spin the Wheel â€¢ V2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.4/TweenMax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@2.7.0/Winwheel.min.js"></script>
  <script type="module" src="./effects-v2.js"></script>
  <style>
    html, body { background:#000; color:#fff; font-family: Inter, system-ui, sans-serif; text-align:center; margin:0; padding:0; overflow:hidden; height:100vh; }
    .main { height:100vh; display:grid; grid-template-columns: 1fr; align-items:center; justify-items:center; padding:16px; box-sizing:border-box; }
    #wheel-wrap { position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; }
    #wheel-container { position:relative; width:min(80vmin, 640px); height:min(80vmin, 640px); }
    #pointer { position:absolute; top:-20px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:15px solid transparent; border-right:15px solid transparent; border-top:20px solid red; z-index:10; }
    #canvas-mechanics { position:absolute; top:0; left:0; z-index:1; opacity:0; width:100%; height:100%; }
    #wheel-overlay { position:absolute; top:0; left:0; width:100%; height:100%; z-index:2; pointer-events:none; display:none; }
    #canvas-text { position:absolute; top:0; left:0; z-index:3; pointer-events:none; width:100%; height:100%; }

    #spin-button {
      display:inline-block; padding:12px 22px; font-size:16px; font-weight:800;
      background:#ff4500; color:#fff; border:none; border-radius:14px; cursor:pointer;
    }
    #spin-button:disabled { opacity:0.6; cursor:not-allowed; }

    #message { color:#fff; font-size:18px; font-weight:700; white-space:pre-line; min-height:1.4em; }
    .gold { color:#FFD700; font-weight:900; text-shadow:0 0 10px rgba(255,215,0,0.6); }

    /* canvases injected by effects-v2.js */
    #celebration-canvas, #front-celebration {
      position:fixed; inset:0; pointer-events:none;
    }
    #celebration-canvas { z-index:0; }
    #front-celebration { z-index:2000; }
  </style>
</head>
<body>
  <div class="main">
    <div id="wheel-wrap">
      <div id="wheel-container">
        <div id="pointer"></div>
        <canvas id="canvas-mechanics"></canvas>
        <img id="wheel-overlay" alt="Wheel Overlay"/>
        <canvas id="canvas-text"></canvas>
      </div>
      <button id="spin-button" disabled>SPIN</button>
      <div id="message"></div>
    </div>
  </div>

  <script type="module">
    import * as effects from './effects-v2.js';

    let mechanicsWheel = null;
    let segments = [];
    let announcedPrize = null;
    let finalSpinsLeft = null;

    const qs = new URLSearchParams(window.location.search);
    const token = qs.get("token");
    const server_id = qs.get("server_id");

    const spinButton = document.getElementById("spin-button");
    const messageDiv = document.getElementById("message");
    const overlayImg = document.getElementById("wheel-overlay");

    function resizeCanvas() {
      const container = document.getElementById('wheel-container');
      const size = Math.min(container.offsetWidth, container.offsetHeight);
      [document.getElementById('canvas-mechanics'), document.getElementById('canvas-text')].forEach(c => {
        c.width = size; c.height = size;
      });
    }
    window.addEventListener('resize', () => { resizeCanvas(); drawTextWheel(); });
    resizeCanvas();

    async function initializeWheel() {
      try {
        const res = await fetch("/api/spin", {
          method:"POST", headers:{ "Content-Type": "application/json" },
          body: JSON.stringify({ token, server_id })
        });
        const data = await res.json();
        if (!res.ok || !data.tokenConfig) throw new Error(data.error || "Failed to load spin configuration");

        const { token_name, payout_amounts, payout_weights, image_url } = data.tokenConfig;
        segments = payout_amounts.map(a => ({
          text:`${a}`, text2:token_name, textFillStyle:'white', textFontFamily:'Arial'
        }));

        if (image_url) { overlayImg.src=image_url; overlayImg.style.display='block'; }

        const container = document.getElementById('wheel-container');
        const radius = Math.min(container.offsetWidth, container.offsetHeight) / 2;

        mechanicsWheel = new Winwheel({
          canvasId: 'canvas-mechanics',
          numSegments: segments.length,
          segments: segments.map(() => ({ fillStyle:'transparent', strokeStyle:'none' })),
          outerRadius: radius,
          pointerAngle:90,
          animation: {
            type:'spinToStop', duration:5, spins:8,
            callbackFinished: () => {
              const spinsLeftText = typeof finalSpinsLeft === 'number' ? `Spins Left Today: ${finalSpinsLeft}` : 'Unlimited spins';
              messageDiv.innerHTML = announcedPrize
                ? `You won: <span class="gold">${announcedPrize}</span>\n${spinsLeftText}`
                : `Spin complete.\n${spinsLeftText}`;
              effects.onWin({ prize: announcedPrize, rare: true }); // let effects decide rare vs common
            },
            callbackBefore: () => {
              effects.tick(mechanicsWheel.rotationAngle);
              drawTextWheel(mechanicsWheel.rotationAngle - 60);
              overlayImg.style.transform = `rotate(${mechanicsWheel.rotationAngle-30}deg)`;
            }
          }
        });

        drawTextWheel();
        spinButton.disabled = false;
      } catch (err) {
        messageDiv.textContent = err.message;
        spinButton.disabled = true;
      }
    }

    function drawTextWheel(rotation=-60) {
      const canvas=document.getElementById("canvas-text");
      const ctx=canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const centerX=canvas.width/2, centerY=canvas.height/2;
      const numSegments=segments.length;
      if (!numSegments) return;
      const radius=Math.min(canvas.width,canvas.height)/2;
      const numFontPx=Math.round(radius*0.12), tokenFontPx=Math.round(radius*0.09);
      const qRadius=radius*0.8, tRadius=qRadius*0.85;
      const segAngle=(2*Math.PI)/numSegments;
      for (let i=0;i<numSegments;i++){
        const seg=segments[i];
        const angle=(rotation*Math.PI/180)+(i*segAngle)+(segAngle/2);
        ctx.save(); ctx.translate(centerX,centerY); ctx.rotate(angle);
        ctx.fillStyle=seg.textFillStyle||'white'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.font=`${numFontPx}px ${seg.textFontFamily||'Arial'}`; ctx.fillText(seg.text,0,-qRadius);
        ctx.font=`${tokenFontPx}px ${seg.textFontFamily||'Arial'}`; ctx.fillText(seg.text2,0,-tRadius);
        ctx.restore();
      }
    }

    async function doSpin() {
      const spinButton = document.getElementById("spin-button");
      spinButton.disabled = true;
      const messageDiv = document.getElementById("message");
      messageDiv.textContent = "Preparing your spin...";
      effects.startSpin();
      try {
        const res = await fetch("/api/spin", {
          method:"POST", headers:{ "Content-Type": "application/json" },
          body: JSON.stringify({ token, spin:true, server_id })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error||"Spin failed");

        const segmentIndex=data.segmentIndex;
        const seg=mechanicsWheel.segments[segmentIndex+1];
        if (!seg) throw new Error("Invalid segment");
        const center=(seg.startAngle+seg.endAngle)/2;
        mechanicsWheel.animation.stopAngle=(center + (Math.random()*(seg.endAngle-seg.startAngle)*0.8) - ((seg.endAngle-seg.startAngle)*0.4)) % 360;

        announcedPrize=data.prize;
        finalSpinsLeft=data.spins_left;
        mechanicsWheel.stopAnimation(false);
        mechanicsWheel.rotationAngle=0;
        mechanicsWheel.draw();
        drawTextWheel(-60);
        mechanicsWheel.startAnimation();
      } catch (err) {
        messageDiv.textContent=err.message;
        spinButton.disabled=false;
        effects.stopSpinSound();
      }
    }

    document.getElementById('spin-button').addEventListener('click', doSpin);
    initializeWheel();
  </script>

  <!-- Load the ATA gate AFTER the inline module so it can intercept the click -->
  <script type="module" src="./atadetection.js"></script>
</body>
</html>
